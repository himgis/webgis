<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Web GIS - Layers List Right</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        #layerPanel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0px 0px 6px #999;
            max-height: 85vh;
            overflow-y: auto;
            width: 260px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #ddd;
        }

        .layer-item span {
            cursor: pointer;
        }

        .delete-btn {
            cursor: pointer;
            color: red;
            margin-left: 10px;
            font-size: 18px;
        }

        .color-box {
            width: 14px;
            height: 14px;
            border: 1px solid #333;
            display: inline-block;
            margin-right: 6px;
        }

        #adminControls {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #bbb;
        }

        #logoutBtn, #uploadBtn {
            margin-top: 8px;
            padding: 8px;
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

    </style>
</head>
<body>

<div id="map"></div>

<div id="layerPanel">
    <h3>Layers</h3>
    <div id="layerList"></div>

    {% if is_admin %}
    <div id="adminControls">
        <button id="uploadBtn" onclick="window.location='/upload_page'">Upload Layers</button>
        <button id="logoutBtn" onclick="logout()">Logout</button>
    </div>
    {% endif %}

</div>

<script>
let map = L.map("map").setView([22.5, 78.9], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
}).addTo(map);

let allLayers = {};          // name ‚Üí L.geoJSON layer
let layerVisibility = {};    // name ‚Üí true/false
let isAdmin = {{ 'true' if is_admin else 'false' }};

function logout() {
    fetch('/logout')
        .then(() => window.location.reload());
}


// ==============================
// Load Layers from backend
// ==============================
function loadLayers() {
    fetch("/layers")
        .then(r => r.json())
        .then(data => {
            
            // Only update UI when layer count changes (no flicker)
            if (Object.keys(data.layers).length !== Object.keys(allLayers).length) {
                updateLayerListUI(data.layers);
            }

            // Always update map layers
            updateMapLayers(data.layers, data.bounds);
        });
}


// ==============================
// Update UI Layer List
// ==============================
function updateLayerListUI(layersFromServer) {
    const list = document.getElementById("layerList");
    list.innerHTML = "";

    for (const name in layersFromServer) {
        const lyr = layersFromServer[name];
        const color = lyr.color;

        let div = document.createElement("div");
        div.className = "layer-item";

        div.innerHTML = `
            <label>
                <input type="checkbox" ${layerVisibility[name] !== false ? "checked" : ""} 
                       onchange="toggleLayer('${name}', this.checked)">
                <span><span class="color-box" style="background:${color}"></span> ${name}</span>
            </label>

            ${isAdmin ? `<span class="delete-btn" onclick="deleteLayer('${name}')">üóëÔ∏è</span>` : ""}
        `;

        list.appendChild(div);
    }
}


// ==============================
// Delete Layer From Server + Map
// ==============================
function deleteLayer(name) {
    if (!confirm(`Delete layer "${name}" permanently?`)) return;

    fetch(`/delete/${name}`, { method: "DELETE" })
        .then(r => r.json())
        .then(res => {
            if (res.message === "Deleted") {
                if (allLayers[name]) map.removeLayer(allLayers[name]);
                delete allLayers[name];
                delete layerVisibility[name];
                loadLayers();   // update UI safely
            } else {
                alert(res.error);
            }
        });
}


// ==============================
// Add Layers to Map (popup stays)
// ==============================
function updateMapLayers(layersFromServer, bounds) {

    for (const name in layersFromServer) {
        const geojson = layersFromServer[name].geojson;
        const color = layersFromServer[name].color;

        // first time add
        if (!allLayers[name]) {

            let layer = L.geoJSON(geojson, {
                style: () => ({
                    color: color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.5
                }),

                pointToLayer: (feature, latlng) =>
                    L.circleMarker(latlng, {
                        radius: 6,
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.7,
                        weight: 2
                    }),

                onEachFeature: (f, l) => {
                    if (f.properties) {
                        let html = `<table style="font-size:13px;">`;
                        for (const [k, v] of Object.entries(f.properties)) {
                            html += `<tr><td><b>${k}</b></td><td>${v}</td></tr>`;
                        }
                        html += `</table>`;
                        l.bindPopup(html);
                    }
                }
            });

            if (layerVisibility[name] !== false) {
                layer.addTo(map);
                layerVisibility[name] = true;
            }

            allLayers[name] = layer;
        }

        // üö´ DO NOT REMOVE OR REBUILD ‚Üí popup fix
        // keeps existing layer alive
    }

    if (bounds && Object.keys(allLayers).length > 0) {
        map.fitBounds(bounds);
    }
}


// ==============================
// Toggle Layer Visibility
// ==============================
function toggleLayer(name, state) {
    layerVisibility[name] = state;
    if (state) {
        allLayers[name].addTo(map);
    } else {
        map.removeLayer(allLayers[name]);
    }
}

// Initial load and refresh safely
loadLayers();
setInterval(loadLayers, 3000);

</script>

</body>
</html>
