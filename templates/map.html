<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Web GIS - Layers Visibility Bottom-Left</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.1/dist/L.Control.Locate.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.1/dist/L.Control.Locate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        body, html { margin:0; padding:0; height:100% }
        #map { width:100%; height:100vh; position:relative }

        /* ADMIN MENU */
        #adminMenu {
            position:absolute; top:10px; left:10px;
            background:white; padding:10px; border-radius:6px;
            box-shadow:0 2px 10px rgba(0,0,0,0.3);
            z-index:1500; font-family:Roboto,sans-serif;
            display:none;
        }

        .style-panel {
            position:absolute; top:10px; right:10px;
            background:white; padding:15px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3);
            z-index:1000; width:280px;
        }

        .layer-panel {
            position:absolute; bottom:10px; left:10px;
            background:white; padding:12px;
            border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.3);
            z-index:1000; width:260px; max-height:70vh;
            overflow-y:auto;
        }

        .panel h3 {
            margin:0 0 10px 0; background:#4285f4; color:white;
            padding:8px 12px; border-radius:5px;
        }

        .layer-item {
            padding:6px 5px; border-bottom:1px solid #eee;
            display:flex; justify-content:space-between;
            align-items:center; user-select:none;
        }

        .layer-tools button {
            margin-left:4px;
            cursor:pointer;
            border:none;
            background:#eee;
            padding:4px 6px;
            border-radius:4px;
        }

        .delete-btn { color:red; cursor:pointer; margin-left:6px; }
    </style>
</head>
<body>

<!-- ADMIN MENU -->
<div id="adminMenu">
    <a href="/upload_page">Upload Shapefile</a>
    <button onclick="logout()">Logout</button>
</div>

<div id="map"></div>

<!-- Style Panel -->
<div class="panel style-panel">
    <h3>Layer Style</h3>

    <label>Line Weight: <span id="wVal">3</span></label>
    <input type="range" id="weight" min="1" max="10" value="3">

    <label>Fill Opacity: <span id="oVal">0.05</span></label>
    <input type="range" id="opacity" min="0" max="1" step="0.05" value="0.05">

    <label>Point Size: <span id="rVal">8</span></label>
    <input type="range" id="radius" min="4" max="20" value="8">
</div>

<!-- Layers Panel -->
<div class="panel layer-panel">
    <h3>Layers</h3>
    <div id="layerList"><em>Loading layers...</em></div>
</div>

<script>
const map = L.map('map').setView([22.5, 73.0], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.control.locate({
    position:"topleft",
    icon:"fa fa-location-crosshairs",
    setView:"untilPanOrZoom",
    locateOptions:{enableHighAccuracy:true}
}).addTo(map);

function logout(){ fetch("/logout").then(()=>location.reload()); }

let allLayers = {};
let layerVisibility = {};
let layerOrder = [];   // â¬… store layer order
let previousLayerNames = [];
let isAdmin = false;

let styleConfig = { weight:3, fillOpacity:0.05, radius:8 };

function updateDisplays() {
    wVal.textContent = styleConfig.weight;
    oVal.textContent = styleConfig.fillOpacity;
    rVal.textContent = styleConfig.radius;
}

["weight","opacity","radius"].forEach(id=>{
    document.getElementById(id).oninput=e=>{
        styleConfig[id==="opacity"?"fillOpacity":id]=+e.target.value;
        updateDisplays();
        Object.values(allLayers).forEach(layer=>{
            layer.eachLayer(l=>{
                const c=l.feature.properties._color;
                const st={color:c,fillColor:c,weight:styleConfig.weight,fillOpacity:styleConfig.fillOpacity};
                if(l.setStyle) l.setStyle(st);
                if(l.setRadius) l.setRadius(styleConfig.radius);
            });
        });
    };
});

// DELETE LAYER
function deleteLayer(name){
    if(!confirm(`Delete "${name}"?`)) return;
    fetch(`/delete/${encodeURIComponent(name)}`,{method:"DELETE"})
        .then(r=>r.json()).then(d=>{
            if(d.message){
                map.removeLayer(allLayers[name]);
                delete allLayers[name];
                layerOrder = layerOrder.filter(n => n!==name);
                loadLayers();
            }
        });
}

// ðŸ”¥ MOVE LAYER (UP / DOWN)
function moveLayer(name, direction) {
    let i = layerOrder.indexOf(name);
    let j = i + direction;
    if(j < 0 || j >= layerOrder.length) return;

    // Swap
    [layerOrder[i], layerOrder[j]] = [layerOrder[j], layerOrder[i]];

    // Reorder on map
    map.eachLayer(l => { if(l !== baseLayer) map.removeLayer(l); });

    layerOrder.forEach(n => {
        if(allLayers[n] && layerVisibility[n] !== false) {
            allLayers[n].addTo(map);
        }
    });

    updateLayerCheckboxes(layerOrder);
}

// LOAD LAYERS
async function loadLayers(){
    const res = await fetch("/layers");
    const data = await res.json();

    isAdmin = data.is_admin;
    adminMenu.style.display = isAdmin ? "block" : "none";

    let names = Object.keys(data.layers);

    // Initialize order only first time
    if (layerOrder.length === 0) layerOrder = [...names];

    // Remove missing layers
    previousLayerNames.forEach(n=>{
        if(!names.includes(n)){
            map.removeLayer(allLayers[n]);
            delete allLayers[n];
            layerOrder = layerOrder.filter(x => x !== n);
        }
    });

    for(const [name,info] of Object.entries(data.layers)){
        const geojson = info.geojson;
        const color = info.color;

        geojson.features.forEach(f=>{
            if(!f.properties) f.properties={};
            f.properties._color=color;
        });

        if(!allLayers[name]){
            let layer = L.geoJSON(geojson,{
                style:{color,fillColor:color,weight:3,fillOpacity:0.05},
                pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:8,color,fillColor:color,fillOpacity:0.05}),
                onEachFeature:(f,l)=>l.bindPopup(JSON.stringify(f.properties))
            });

            allLayers[name]=layer;
            if(layerVisibility[name]!==false){
                layer.addTo(map);
                layerVisibility[name]=true;
            }
        }
    }

    updateLayerCheckboxes(layerOrder);
    previousLayerNames = names;
}

// UPDATE UI LIST
function updateLayerCheckboxes(names){
    const div = document.getElementById("layerList");
    div.innerHTML="";

    names.forEach(name=>{
        const row=document.createElement("div");
        row.className="layer-item";

        // Left: checkbox + name
        const left=document.createElement("span");
        const cb=document.createElement("input");
        cb.type="checkbox";
        cb.checked = layerVisibility[name] !== false;
        cb.onchange=()=>{
            layerVisibility[name]=cb.checked;
            cb.checked ? allLayers[name].addTo(map) : map.removeLayer(allLayers[name]);
        };
        const label=document.createElement("label");
        label.textContent=name;
        left.appendChild(cb);
        left.appendChild(label);

        row.appendChild(left);

        // Right: Tools (Admin only)
        if(isAdmin){
            const tools=document.createElement("span");
            tools.className="layer-tools";

            const up=document.createElement("button");
            up.textContent="â¬†ï¸";
            up.onclick = ()=>moveLayer(name, -1);

            const down=document.createElement("button");
            down.textContent="â¬‡ï¸";
            down.onclick = ()=>moveLayer(name, +1);

            const del=document.createElement("span");
            del.className="delete-btn";
            del.textContent="ðŸ—‘ï¸";
            del.onclick = ()=>deleteLayer(name);

            tools.appendChild(up);
            tools.appendChild(down);
            tools.appendChild(del);

            row.appendChild(tools);
        }

        div.appendChild(row);
    });
}

// AUTO REFRESH
loadLayers();
setInterval(loadLayers,3000);
</script>

</body>
</html>
